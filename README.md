# 加密货币交易AI系统 - 开发指南

## 📋 项目概述

这是一个基于多层AI代理协作的加密货币自动交易系统，使用Claude API实现智能决策。

### 核心特性

✅ **多层AI架构** - 宏观规划、专业分析、综合决策三层协作  
✅ **可视化决策树** - Web界面实时展示AI协作过程  
✅ **记忆系统** - AI能够学习历史经验并持续改进  
✅ **模拟/实盘切换** - 统一接口，安全测试  
✅ **完整风控** - 止损、仓位管理、熔断机制  
✅ **回测系统** - 验证策略有效性  

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────┐
│                  Web前端 (React)                     │
│           仪表盘 | AI决策树 | 交易中心                │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP/WebSocket
┌──────────────────────┼──────────────────────────────┐
│              后端API (FastAPI)                       │
│  ┌─────────────────┬──────────────┬────────────┐   │
│  │ 系统管理        │ 交易执行      │ 数据服务    │   │
│  └─────────────────┴──────────────┴────────────┘   │
└──────────────────────┬──────────────────────────────┘
                       │
┌──────────────────────┼──────────────────────────────┐
│              AI代理层 (Claude API)                   │
│                                                      │
│  ┌──────────────────────────────────────────────┐  │
│  │         宏观规划AI (Macro Planner)            │  │
│  │  - 分析市场环境                               │  │
│  │  - 制定高层策略                               │  │
│  │  - 分配任务给下层AI                           │  │
│  └───────────────┬──────────────────────────────┘  │
│                  │                                  │
│  ┌───────────────┴──────────────────────────────┐  │
│  │          分析层AI (并行执行)                  │  │
│  ├──────────────┬──────────────┬────────────────┤  │
│  │技术分析AI    │基本面分析AI  │情绪分析AI      │  │
│  │- K线形态     │- 链上数据    │- 市场情绪      │  │
│  │- 技术指标    │- 资金费率    │- 新闻分析      │  │
│  │- 支撑阻力    │- 持仓量      │- 恐贪指数      │  │
│  ├──────────────┴──────────────┴────────────────┤  │
│  │          风险评估AI                           │  │
│  │          - 仓位风险                            │  │
│  │          - 波动率                              │  │
│  │          - 止损止盈                            │  │
│  └───────────────┬──────────────────────────────┘  │
│                  │                                  │
│  ┌───────────────┴──────────────────────────────┐  │
│  │       决策层AI (Decision Maker)               │  │
│  │  - 综合所有分析                               │  │
│  │  - 动态权重调整                               │  │
│  │  - 输出最终交易决策                           │  │
│  └──────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────┘
                       │
┌──────────────────────┼──────────────────────────────┐
│              数据与执行层                             │
│  ┌─────────────┬────────────┬──────────────────┐   │
│  │币安API      │数据采集     │仓位管理          │   │
│  │- 实时行情   │- K线数据    │- 模拟盘/实盘     │   │
│  │- 订单执行   │- 技术指标   │- 盈亏计算        │   │
│  │- 账户信息   │- 新闻情绪   │- 风险暴露        │   │
│  └─────────────┴────────────┴──────────────────┘   │
│                                                      │
│  ┌─────────────────────────────────────────────┐   │
│  │         记忆系统 (SQLite)                    │   │
│  │  - 短期记忆 (24小时)                         │   │
│  │  - 长期记忆 (永久,带清理)                    │   │
│  │  - 情景记忆 (重要事件)                       │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

---

## 📂 开发阶段

本项目分为5个开发阶段，每个阶段都有详细的提示词文档：

### 阶段1: 基础架构和数据层
**文件**: `stage1_infrastructure.md`

**内容**:
- 币安API封装 (binance_api.py)
- 数据库设计 (SQLite + SQLAlchemy)
- 数据采集工具 (市场数据、新闻、链上数据)
- 技术指标计算器
- 项目基础结构搭建

**预计时间**: 2-3天

---

### 阶段2: AI代理系统
**文件**: `stage2_ai_agents.md`

**内容**:
- AI代理基类 (BaseAgent)
- 宏观规划AI实现
- 4个专业分析AI (技术/基本面/情绪/风险)
- 决策层AI实现
- AI协同工作流引擎

**预计时间**: 3-4天

**重点**: Claude API调用、系统提示词设计、AI间通信协议

---

### 阶段3: 记忆系统和交易执行
**文件**: `stage3_memory_execution.md`

**内容**:
- 智能记忆系统 (短期/长期/情景记忆)
- 仓位管理 (模拟盘/实盘统一接口)
- 交易执行层 (订单验证、执行、追踪)
- 策略配置系统 (灵活调整交易偏好)
- 回测系统 (验证策略有效性)

**预计时间**: 2-3天

---

### 阶段4: Web界面和可视化
**文件**: `stage4_web_interface.md`

**内容**:
- FastAPI后端 (REST API + WebSocket)
- React前端 (TypeScript + TailwindCSS)
- AI决策树可视化 (React Flow)
- 仪表盘组件 (账户、持仓、交易)
- Docker部署

**预计时间**: 3-5天

**重点**: 实时数据推送、交互式决策树、响应式设计

---

### 阶段5: 测试、优化和监控
**文件**: `stage5_testing_optimization.md`

**内容**:
- 单元测试和集成测试 (pytest, Jest)
- 性能优化 (数据库、缓存、异步)
- 日志和监控系统 (Prometheus, Grafana)
- 错误处理和容错机制
- 安全性加固

**预计时间**: 2-3天

---

## 🚀 快速开始

### 1. 按阶段开发

```bash
# 克隆项目结构
mkdir crypto_trading_agent && cd crypto_trading_agent

# 阶段1: 基础设施
# 阅读 stage1_infrastructure.md
# 按提示词逐个生成代码文件

# 阶段2: AI代理
# 阅读 stage2_ai_agents.md
# 实现AI代理系统

# ... 依次完成各阶段
```

### 2. 使用提示词

每个阶段的提示词都设计为可以直接复制粘贴给Claude，例如：

```
# 复制 stage1_infrastructure.md 中的 "提示词1.1"
# 粘贴到Claude对话
# Claude会生成完整的代码

# 然后继续"提示词1.2", "提示词1.3" ...
```

### 3. 配置环境

```bash
# 安装Python依赖
pip install -r requirements.txt

# 配置API密钥
cp config/api_keys.yaml.example config/api_keys.yaml
# 编辑 api_keys.yaml 填入币安API密钥

# 初始化数据库
python scripts/init_db.py

# 启动开发服务器
python main.py
```

---

## 🔑 关键技术点

### 1. AI代理通信协议

所有AI间通信使用标准化JSON格式：

```json
{
  "message_id": "uuid",
  "from": "macro_planner",
  "to": "technical_analyst",
  "timestamp": "2025-01-31 10:00:00",
  "message_type": "TASK_ASSIGNMENT",
  "content": {
    "task": "分析BTC技术形态",
    "required_data": ["kline_1h", "kline_4h"],
    "deadline": "2025-01-31 10:05:00"
  }
}
```

### 2. 模拟盘与实盘切换

通过配置文件控制，AI完全无感知：

```yaml
execution:
  mode: "simulated"  # 或 "live"
  # AI只看到统一的仓位数据接口
```

### 3. 记忆重要性评分

自动评估并保留重要记忆：

```python
importance = (
    profit_score * 0.4 +
    volatility_score * 0.3 +
    consensus_score * 0.2 +
    recency_score * 0.1
)
```

---

## 📊 数据流示例

### 完整决策流程

```
1. 触发条件满足 (定时/价格异动/手动)
   ↓
2. 宏观规划AI分析市场环境
   输出: {"market": "牛市", "strategy": "稳健", "tasks": [...]}
   ↓
3. 并行调用4个分析AI
   - 技术分析AI → {"trend": "上涨", "confidence": 0.8}
   - 基本面AI → {"score": 75, "recommendation": "买入"}
   - 情绪AI → {"sentiment": "贪婪", "warning": true}
   - 风险AI → {"risk": "中", "stop_loss": 43000}
   ↓
4. 决策层AI综合分析
   输出: {
     "decision": "BUY",
     "symbol": "BTCUSDT",
     "quantity": 0.05,
     "confidence": 0.75
   }
   ↓
5. 执行层验证并下单
   - 余额检查 ✓
   - 风险检查 ✓
   - 下单执行 ✓
   ↓
6. 记录到数据库 + 更新仓位 + 记忆存储
```

---

## ⚠️ 重要注意事项

### 1. 安全性

- **永远不要**将API密钥提交到代码仓库
- 使用环境变量或加密文件存储敏感信息
- 建议先用模拟盘充分测试
- 设置合理的止损和仓位限制

### 2. API调用成本

- Claude API按token计费，注意控制调用频率
- 建议使用缓存减少重复调用
- 可以调整AI决策触发频率

### 3. 风险控制

系统内置多重风控：
- 单日亏损>5%自动熔断
- 单笔交易不超过总资产30%
- 每个决策必须设置止损
- 支持人工确认模式

### 4. 数据准确性

- 技术分析依赖历史数据质量
- 新闻情绪分析可能有延迟
- 链上数据需要可靠的数据源

---

## 📖 推荐开发顺序

### 第1周: 基础搭建
- Day 1-2: 阶段1 (数据层)
- Day 3-4: 阶段2前半 (AI基类和宏观AI)
- Day 5-7: 阶段2后半 (分析AI和决策AI)

### 第2周: 核心功能
- Day 1-2: 阶段3前半 (记忆和仓位管理)
- Day 3-4: 阶段3后半 (交易执行和回测)
- Day 5-7: 阶段4前半 (后端API)

### 第3周: 界面和优化
- Day 1-3: 阶段4后半 (前端界面)
- Day 4-5: 阶段5 (测试和优化)
- Day 6-7: 完整测试和调试

---

## 🛠️ 故障排查

### 常见问题

**Q: Claude API调用失败**
```python
# 检查API密钥是否正确
# 检查网络连接
# 查看错误日志: logs/error.log
```

**Q: 数据库锁定错误**
```python
# SQLite并发限制，考虑使用连接池
# 或升级到PostgreSQL
```

**Q: WebSocket连接断开**
```python
# 检查前端reconnect逻辑
# 查看nginx配置proxy_timeout设置
```

---

## 📚 扩展方向

### 未来可能的增强

1. **更多交易对**: 支持更多加密货币
2. **合约交易**: 添加永续合约支持
3. **多交易所**: 集成其他交易所API
4. **高频交易**: 优化延迟，支持高频策略
5. **机器学习**: 训练预测模型辅助决策
6. **移动端**: 开发React Native应用

---

## 📄 许可证

本项目仅供学习和研究使用。

**免责声明**: 
- 加密货币交易有风险，本系统不保证盈利
- 请在充分了解风险后使用
- 作者不对任何交易损失负责

---

## 🤝 贡献

欢迎提交问题和改进建议！

---

## 📞 支持

如果在开发过程中遇到问题：
1. 检查对应阶段的提示词文档
2. 查看日志文件
3. 参考本README的故障排查部分

祝开发顺利！🚀
